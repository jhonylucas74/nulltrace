syntax = "proto3";
package game;

service GameService {
  rpc SayHello (HelloRequest) returns (HelloResponse);
  rpc Ping (PingRequest) returns (PingResponse);
  rpc Login (LoginRequest) returns (LoginResponse);
  rpc RefreshToken (RefreshTokenRequest) returns (RefreshTokenResponse);
  rpc TerminalStream (stream TerminalClientMessage) returns (stream TerminalServerMessage);
  rpc ProcessSpyStream (stream ProcessSpyClientMessage) returns (stream ProcessSpyServerMessage);
  rpc GetDiskUsage (GetDiskUsageRequest) returns (GetDiskUsageResponse);
  rpc GetProcessList (GetProcessListRequest) returns (GetProcessListResponse);
  rpc GetSysinfo (GetSysinfoRequest) returns (GetSysinfoResponse);
  rpc RestoreDisk (RestoreDiskRequest) returns (RestoreDiskResponse);
  rpc GetHomePath (GetHomePathRequest) returns (GetHomePathResponse);
  rpc ListFs (ListFsRequest) returns (ListFsResponse);
  rpc CopyPath (CopyPathRequest) returns (CopyPathResponse);
  rpc MovePath (MovePathRequest) returns (MovePathResponse);
  rpc RenamePath (RenamePathRequest) returns (RenamePathResponse);
  rpc CreateFolder (CreateFolderRequest) returns (CreateFolderResponse);
  rpc WriteFile (WriteFileRequest) returns (WriteFileResponse);
  rpc ReadFile (ReadFileRequest) returns (ReadFileResponse);
  rpc EmptyTrash (EmptyTrashRequest) returns (EmptyTrashResponse);
  rpc GetInstalledStoreApps (GetInstalledStoreAppsRequest) returns (GetInstalledStoreAppsResponse);
  rpc InstallStoreApp (InstallStoreAppRequest) returns (InstallStoreAppResponse);
  rpc UninstallStoreApp (UninstallStoreAppRequest) returns (UninstallStoreAppResponse);
  rpc GetRanking (GetRankingRequest) returns (GetRankingResponse);
  rpc GetPlayerProfile (GetPlayerProfileRequest) returns (GetPlayerProfileResponse);
  rpc SetPreferredTheme (SetPreferredThemeRequest) returns (SetPreferredThemeResponse);
  rpc SetShortcuts (SetShortcutsRequest) returns (SetShortcutsResponse);
  rpc CreateFaction (CreateFactionRequest) returns (CreateFactionResponse);
  rpc LeaveFaction (LeaveFactionRequest) returns (LeaveFactionResponse);
  rpc RunProcess (RunProcessRequest) returns (stream RunProcessResponse);
  rpc GetEmails (GetEmailsRequest) returns (GetEmailsResponse);
  rpc SendEmail (SendEmailRequest) returns (SendEmailResponse);
  rpc MarkEmailRead (MarkEmailReadRequest) returns (MarkEmailReadResponse);
  rpc MoveEmail (MoveEmailRequest) returns (MoveEmailResponse);
  rpc DeleteEmail (DeleteEmailRequest) returns (DeleteEmailResponse);
  rpc MailboxStream (MailboxStreamRequest) returns (stream MailboxStreamMessage);

  // ── Wallet ────────────────────────────────────────────────────────────────
  rpc GetWalletBalances (GetWalletBalancesRequest) returns (GetWalletBalancesResponse);
  rpc GetWalletTransactions (GetWalletTransactionsRequest) returns (GetWalletTransactionsResponse);
  rpc GetWalletKeys (GetWalletKeysRequest) returns (GetWalletKeysResponse);
  rpc TransferFunds (TransferFundsRequest) returns (TransferFundsResponse);
  rpc ConvertFunds (ConvertFundsRequest) returns (ConvertFundsResponse);
  rpc GetWalletCards (GetWalletCardsRequest) returns (GetWalletCardsResponse);
  rpc CreateWalletCard (CreateWalletCardRequest) returns (CreateWalletCardResponse);
  rpc DeleteWalletCard (DeleteWalletCardRequest) returns (DeleteWalletCardResponse);
  rpc GetCardTransactions (GetCardTransactionsRequest) returns (GetCardTransactionsResponse);
  rpc GetCardStatement (GetCardStatementRequest) returns (GetCardStatementResponse);
  rpc PayCardBill (PayCardBillRequest) returns (PayCardBillResponse);
}

message HelloRequest {
  string player_name = 1;
}

message HelloResponse {
  string greeting = 1;
}

message PingRequest {}

message PingResponse {
  int64 server_time_ms = 1;
}

message LoginRequest {
  string username = 1;
  string password = 2;
}

message LoginResponse {
  bool success = 1;
  string player_id = 2;
  string token = 3;
  string error_message = 4;
  string preferred_theme = 5;
  string shortcuts_overrides = 6;
}

message RefreshTokenRequest {
  string current_token = 1;
}

message RefreshTokenResponse {
  bool success = 1;
  string token = 2;
  string error_message = 3;
}

message TerminalClientMessage {
  oneof msg {
    OpenTerminal open_terminal = 1;
    StdinData stdin = 2;
    Interrupt interrupt = 3;
    OpenCodeRun open_code_run = 4;
  }
}

message Interrupt {}

message OpenTerminal {}

message OpenCodeRun {
  string path = 1;
}

message StdinData {
  bytes data = 1;
}

message TerminalServerMessage {
  oneof msg {
    TerminalOpened terminal_opened = 1;
    StdoutData stdout = 2;
    TerminalClosed terminal_closed = 3;
    TerminalError terminal_error = 4;
    PromptReady prompt_ready = 5;
  }
}

// Sent when the shell is ready for the next command (foreground process finished or builtin completed).
message PromptReady {}

message TerminalOpened {
  string session_id = 1;
}

message StdoutData {
  bytes data = 1;
}

message TerminalClosed {}

message TerminalError {
  string message = 1;
}

// RunProcess: run a VM binary with args, stream stdout then finished(exit_code).
message RunProcessRequest {
  string bin_name = 1;
  repeated string args = 2;
}

message RunProcessResponse {
  oneof msg {
    bytes stdout_chunk = 1;
    RunProcessFinished finished = 2;
  }
}

message RunProcessFinished {
  int32 exit_code = 1;
}

// Process Spy: bidirectional stream to list processes and attach to PIDs for stdin/stdout.
message ProcessSpyClientMessage {
  oneof msg {
    OpenProcessSpy open_process_spy = 1;
    SubscribePid subscribe_pid = 2;
    UnsubscribePid unsubscribe_pid = 3;
    InjectStdin inject_stdin = 4;
    SpawnLuaScript spawn_lua_script = 5;
    KillProcess kill_process = 6;
  }
}

message SpawnLuaScript {
  string path = 1;
}

message KillProcess {
  uint64 pid = 1;
}

message OpenProcessSpy {}

message SubscribePid {
  uint64 pid = 1;
}

message UnsubscribePid {
  uint64 pid = 1;
}

message InjectStdin {
  uint64 pid = 1;
  bytes data = 2;
}

message ProcessSpyServerMessage {
  oneof msg {
    ProcessSpyOpened process_spy_opened = 1;
    ProcessListSnapshot process_list_snapshot = 2;
    ProcessSpyStdout process_spy_stdout = 3;
    StdinChunk stdin_chunk = 4;
    ProcessGone process_gone = 5;
    ProcessSpyError process_spy_error = 6;
    LuaScriptSpawned lua_script_spawned = 7;
  }
}

message LuaScriptSpawned {
  uint64 pid = 1;
}

message ProcessSpyOpened {}

message ProcessListSnapshot {
  repeated ProcessEntry processes = 1;
}

message ProcessSpyStdout {
  uint64 pid = 1;
  bytes data = 2;
}

message StdinChunk {
  uint64 pid = 1;
  bytes data = 2;
}

message ProcessGone {
  uint64 pid = 1;
}

message ProcessSpyError {
  string message = 1;
}

message GetDiskUsageRequest {}

message GetDiskUsageResponse {
  int64 used_bytes = 1;
  int64 total_bytes = 2;
  string error_message = 3;
}

message GetProcessListRequest {}

message ProcessEntry {
  uint64 pid = 1;
  string name = 2;
  string username = 3;
  string status = 4;
  uint64 memory_bytes = 5;
  repeated string args = 6;  // Full argv used to invoke the process (always shown in Proc Spy)
}

message GetProcessListResponse {
  repeated ProcessEntry processes = 1;
  int64 disk_used_bytes = 2;
  int64 disk_total_bytes = 3;
  string error_message = 4;
  uint64 vm_lua_memory_bytes = 5;  // Real Lua heap usage (bytes)
}

message GetSysinfoRequest {}

message GetSysinfoResponse {
  int32 cpu_cores = 1;
  int32 memory_mb = 2;
  int32 disk_mb = 3;
  string error_message = 4;
}

message RestoreDiskRequest {}

message RestoreDiskResponse {
  bool success = 1;
  string error_message = 2;
}

message GetHomePathRequest {}

message GetHomePathResponse {
  string home_path = 1;
  string error_message = 2;
}

message ListFsRequest {
  string path = 2;
}

message ListFsResponse {
  repeated FsEntry entries = 1;
  string error_message = 2;
}

message FsEntry {
  string name = 1;
  string node_type = 2;
  int64 size_bytes = 3;
}

message CopyPathRequest {
  string src_path = 2;
  string dest_path = 3;
}

message CopyPathResponse {
  bool success = 1;
  string error_message = 2;
}

message MovePathRequest {
  string src_path = 2;
  string dest_path = 3;
}

message MovePathResponse {
  bool success = 1;
  string error_message = 2;
}

message RenamePathRequest {
  string path = 2;
  string new_name = 3;
}

message RenamePathResponse {
  bool success = 1;
  string error_message = 2;
}

message CreateFolderRequest {
  string path = 1;
}

message CreateFolderResponse {
  bool success = 1;
  string error_message = 2;
}

message WriteFileRequest {
  string path = 2;
  bytes content = 3;
}

message WriteFileResponse {
  bool success = 1;
  string error_message = 2;
}

message ReadFileRequest {
  string path = 1;
}

message ReadFileResponse {
  bool success = 1;
  string error_message = 2;
  bytes content = 3;
}

message EmptyTrashRequest {}

message EmptyTrashResponse {
  bool success = 1;
  string error_message = 2;
}

message GetInstalledStoreAppsRequest {}

message GetInstalledStoreAppsResponse {
  repeated string app_types = 1;
  string error_message = 2;
}

message InstallStoreAppRequest {
  string app_type = 1;
}

message InstallStoreAppResponse {
  bool success = 1;
  string error_message = 2;
}

message UninstallStoreAppRequest {
  string app_type = 1;
}

message UninstallStoreAppResponse {
  bool success = 1;
  string error_message = 2;
}

message GetRankingRequest {}

message RankingEntry {
  uint32 rank = 1;
  string player_id = 2;
  string username = 3;
  int32 points = 4;
  string faction_id = 5;
  string faction_name = 6;
}

message GetRankingResponse {
  repeated RankingEntry entries = 1;
  string error_message = 2;
}

message GetPlayerProfileRequest {}

message GetPlayerProfileResponse {
  uint32 rank = 1;
  int32 points = 2;
  string faction_id = 3;
  string faction_name = 4;
  string error_message = 5;
  string preferred_theme = 6;
  string shortcuts_overrides = 7;
}

message SetPreferredThemeRequest {
  string preferred_theme = 1;
}

message SetPreferredThemeResponse {
  bool success = 1;
  string error_message = 2;
}

message SetShortcutsRequest {
  string shortcuts_overrides_json = 1;
}

message SetShortcutsResponse {
  bool success = 1;
  string error_message = 2;
}

message CreateFactionRequest {
  string name = 1;
}

message CreateFactionResponse {
  string faction_id = 1;
  string name = 2;
  string error_message = 3;
}

message LeaveFactionRequest {}

message LeaveFactionResponse {
  bool success = 1;
  string error_message = 2;
}

// ── Email ──────────────────────────────────────────────────────────────────

message EmailMessage {
  string id = 1;
  string from_address = 2;
  string to_address = 3;
  string subject = 4;
  string body = 5;
  string folder = 6;
  bool read = 7;
  int64 sent_at_ms = 8;
  string cc_address = 9;  // empty = not set (display only; BCC never returned)
}

message GetEmailsRequest {
  string email_address = 1;
  string mail_token = 2;
  string folder = 3;
  int32 page = 4;  // 0-based; server uses fixed page size 50
}

message GetEmailsResponse {
  repeated EmailMessage emails = 1;
  bool has_more = 2;
}

message SendEmailRequest {
  string from_address = 1;
  string mail_token = 2;
  string to_address = 3;
  string subject = 4;
  string body = 5;
  string cc_address = 6;  // empty = not set
  string bcc_address = 7; // empty = not set
}

message SendEmailResponse {
  bool success = 1;
  string error_message = 2;
}

message MarkEmailReadRequest {
  string email_address = 1;
  string mail_token = 2;
  string email_id = 3;
  bool read = 4;
}

message MarkEmailReadResponse {
  bool success = 1;
}

message MoveEmailRequest {
  string email_address = 1;
  string mail_token = 2;
  string email_id = 3;
  string folder = 4;
}

message MoveEmailResponse {
  bool success = 1;
}

message DeleteEmailRequest {
  string email_address = 1;
  string mail_token = 2;
  string email_id = 3;
}

message DeleteEmailResponse {
  bool success = 1;
}

message MailboxStreamRequest {
  string email_address = 1;
  string mail_token = 2;
}

message MailboxStreamMessage {
  oneof payload {
    EmailMessage new_email = 1;
    int64 unread_count = 2;
  }
}

// ── Wallet ────────────────────────────────────────────────────────────────────

message WalletBalance {
  string currency = 1;
  int64  amount   = 2;  // DB-cents; divide by 100 for display
}

message GetWalletBalancesRequest {}

message GetWalletBalancesResponse {
  repeated WalletBalance balances      = 1;
  string                 error_message = 2;
}

message WalletTransaction {
  string id                   = 1;
  string tx_type              = 2;  // credit | debit | transfer_in | transfer_out | convert
  string currency             = 3;
  int64  amount               = 4;  // DB-cents
  int64  fee                  = 5;
  string description          = 6;
  string counterpart_address  = 7;
  int64  created_at_ms        = 8;
}

message GetWalletTransactionsRequest {
  string filter = 1;  // "today" | "7d" | "30d" | "all"
}

message GetWalletTransactionsResponse {
  repeated WalletTransaction transactions = 1;
  string                     error_message = 2;
}

message WalletKey {
  string currency    = 1;
  string key_address = 2;
}

message GetWalletKeysRequest {}

message GetWalletKeysResponse {
  repeated WalletKey keys          = 1;
  string             error_message = 2;
}

message TransferFundsRequest {
  string target_address = 1;
  string currency       = 2;
  int64  amount         = 3;  // DB-cents
}

message TransferFundsResponse {
  bool   success       = 1;
  string error_message = 2;
}

message ConvertFundsRequest {
  string from_currency = 1;
  string to_currency   = 2;
  int64  amount        = 3;  // DB-cents of from_currency
}

message ConvertFundsResponse {
  bool   success          = 1;
  int64  converted_amount = 2;  // DB-cents of to_currency
  string error_message    = 3;
}

message WalletCard {
  string id           = 1;
  string label        = 2;
  string number_full  = 3;
  string last4        = 4;
  int32  expiry_month = 5;
  int32  expiry_year  = 6;
  string cvv          = 7;
  string holder_name  = 8;
  int64  credit_limit = 9;   // DB-cents
  int64  current_debt = 10;  // DB-cents
  bool   is_virtual   = 11;
}

message GetWalletCardsRequest {}

message GetWalletCardsResponse {
  repeated WalletCard cards         = 1;
  string              error_message = 2;
}

message CreateWalletCardRequest {
  string label        = 1;
  int64  credit_limit = 2;  // DB-cents (0 = use default 100000)
}

message CreateWalletCardResponse {
  WalletCard card          = 1;
  string     error_message = 2;
}

message DeleteWalletCardRequest {
  string card_id = 1;
}

message DeleteWalletCardResponse {
  bool   success       = 1;
  string error_message = 2;
}

message CardTransaction {
  string id            = 1;
  string tx_type       = 2;  // purchase | payment | refund
  int64  amount        = 3;  // DB-cents
  string description   = 4;
  int64  created_at_ms = 5;
}

message GetCardTransactionsRequest {
  string card_id = 1;
  string filter  = 2;  // "today" | "7d" | "30d" | "all"
}

message GetCardTransactionsResponse {
  repeated CardTransaction transactions = 1;
  string                   error_message = 2;
}

message CardStatement {
  string id               = 1;
  string card_id          = 2;
  int64  period_start_ms  = 3;
  int64  period_end_ms    = 4;
  int64  total_amount     = 5;  // DB-cents
  string status           = 6;  // open | closed | paid
  int64  due_date_ms      = 7;
}

message GetCardStatementRequest {
  string card_id = 1;
}

message GetCardStatementResponse {
  CardStatement statement    = 1;
  string        error_message = 2;
}

message PayCardBillRequest {
  string card_id = 1;
}

message PayCardBillResponse {
  bool   success       = 1;
  int64  amount_paid   = 2;  // DB-cents actually debited
  string error_message = 3;
}
